<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>DaycareAlert Finder</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      line-height: 1.6;
      color: #333;
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
    }
    h1 {
      color: #0066cc;
      margin-bottom: 20px;
    }
    .form-container {
      background-color: #f9f9f9;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      margin-bottom: 30px;
    }
    .form-group {
      margin-bottom: 15px;
    }
    label {
      display: block;
      font-weight: bold;
      margin-bottom: 5px;
    }
    input, select {
      width: 100%;
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 4px;
      box-sizing: border-box;
    }
    .checkbox-group {
      display: flex;
      flex-wrap: wrap;
      gap: 15px;
    }
    .checkbox-item {
      display: flex;
      align-items: center;
      margin-right: 10px;
    }
    .checkbox-item input {
      width: auto;
      margin-right: 5px;
    }
    button {
      background-color: #0066cc;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 16px;
    }
    button:hover {
      background-color: #0055aa;
    }
    .results-container {
      margin-top: 30px;
    }
    .daycare-card {
      border: 1px solid #ddd;
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 15px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
      background-color: white;
    }
    .daycare-name {
      font-size: 18px;
      font-weight: bold;
      color: #0066cc;
      margin-bottom: 10px;
    }
    .daycare-details {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 15px;
    }
    .detail-group {
      margin-bottom: 10px;
    }
    .detail-label {
      font-weight: bold;
      color: #555;
    }
    .stars {
      color: #f8d64e;
      font-size: 20px;
    }
    .price {
      font-weight: bold;
      color: #009900;
    }
    .highlight {
      background-color: #fffde7;
      border-left: 3px solid #fbc02d;
      padding: 8px;
      margin: 8px 0;
    }
    .loader {
      border: 4px solid #f3f3f3;
      border-top: 4px solid #0066cc;
      border-radius: 50%;
      width: 30px;
      height: 30px;
      animation: spin 2s linear infinite;
      margin: 20px auto;
      display: none;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    .hidden {
      display: none;
    }
    .badge {
      display: inline-block;
      padding: 3px 8px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: bold;
      margin-right: 5px;
      margin-bottom: 5px;
    }
    .badge-blue {
      background-color: #e3f2fd;
      color: #0066cc;
      border: 1px solid #bbdefb;
    }
    .badge-green {
      background-color: #e8f5e9;
      color: #2e7d32;
      border: 1px solid #c8e6c9;
    }
    .badge-orange {
      background-color: #fff8e1;
      color: #ff8f00;
      border: 1px solid #ffecb3;
    }
    .score-pill {
      display: inline-block;
      background-color: #f0f8ff;
      border: 1px solid #0066cc;
      border-radius: 15px;
      padding: 2px 8px;
      font-weight: bold;
      color: #0066cc;
    }
    .warning-pill {
      display: inline-block;
      background-color: #fff5f5;
      border: 1px solid #f44336;
      border-radius: 15px;
      padding: 2px 8px;
      font-weight: bold;
      color: #f44336;
    }
  </style>
</head>
<body>
  <h1>DaycareAlert Finder</h1>
  <p>Find the perfect daycare based on your preferences and location.</p>

  <div class="form-container">
    <div class="form-group">
      <label for="location">Your Location (Address, City, or ZIP)</label>
      <input type="text" id="location" placeholder="Enter your address, city or ZIP code">
    </div>

    <div class="form-group">
      <label for="radius">Search Radius (miles)</label>
      <select id="radius">
        <option value="5">5 miles</option>
        <option value="10" selected>10 miles</option>
        <option value="15">15 miles</option>
        <option value="20">20 miles</option>
        <option value="25">25 miles</option>
        <option value="30">30 miles</option>
      </select>
    </div>

    <div class="form-group">
      <label for="ageGroup">Child's Age Group</label>
      <select id="ageGroup">
        <option value="">All Age Groups</option>
        <option value="infant">Infant (0-17 months)</option>
        <option value="toddler">Toddler (18-35 months)</option>
        <option value="preschool">Preschool (3-5 years)</option>
        <option value="school-age">School Age (6+ years)</option>
      </select>
    </div>

    <div class="form-group">
      <label for="priceRange">Maximum Monthly Budget</label>
      <select id="priceRange">
        <option value="800">$800 or less</option>
        <option value="1000">$1,000 or less</option>
        <option value="1200">$1,200 or less</option>
        <option value="1500" selected>$1,500 or less</option>
        <option value="2000">$2,000 or less</option>
        <option value="2500">$2,500 or less</option>
        <option value="3000">$3,000 or less</option>
      </select>
    </div>

    <div class="form-group">
      <label>Special Programs (Select all that apply)</label>
      <div class="checkbox-group">
        <div class="checkbox-item">
          <input type="checkbox" id="transportation" value="transportation">
          <label for="transportation">Transportation</label>
        </div>
        <div class="checkbox-item">
          <input type="checkbox" id="meals" value="meals">
          <label for="meals">Meals Provided</label>
        </div>
        <div class="checkbox-item">
          <input type="checkbox" id="specialNeeds" value="special_needs">
          <label for="specialNeeds">Special Needs Support</label>
        </div>
        <div class="checkbox-item">
          <input type="checkbox" id="extendedHours" value="night_care">
          <label for="extendedHours">Extended Hours</label>
        </div>
        <div class="checkbox-item">
          <input type="checkbox" id="afterSchool" value="after_school">
          <label for="afterSchool">After School Care</label>
        </div>
        <div class="checkbox-item">
          <input type="checkbox" id="accredited" value="accredited">
          <label for="accredited">Accredited</label>
        </div>
      </div>
    </div>

    <div class="form-group">
      <label>Your Priorities (Select up to 3)</label>
      <div class="checkbox-group">
        <div class="checkbox-item">
          <input type="checkbox" id="safety" value="safety">
          <label for="safety">Safety</label>
        </div>
        <div class="checkbox-item">
          <input type="checkbox" id="education" value="educational">
          <label for="education">Educational Focus</label>
        </div>
        <div class="checkbox-item">
          <input type="checkbox" id="affordability" value="affordability">
          <label for="affordability">Affordability</label>
        </div>
        <div class="checkbox-item">
          <input type="checkbox" id="convenience" value="convenience">
          <label for="convenience">Convenience</label>
        </div>
        <div class="checkbox-item">
          <input type="checkbox" id="activities" value="activities">
          <label for="activities">Activities & Programs</label>
        </div>
      </div>
    </div>

    <button onclick="searchDaycares()">Find Daycares</button>
  </div>

  <div id="loader" class="loader"></div>

  <div id="error-message" class="hidden highlight" style="color: #f44336;"></div>
  
  <div id="results-container" class="results-container hidden">
    <h2>Top Recommended Daycares</h2>
    <p id="results-summary"></p>
    <div id="results-list"></div>
  </div>

  <script>
    // Limit priorities to 3 checkboxes
    document.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
      if (checkbox.id === 'safety' || checkbox.id === 'education' || 
          checkbox.id === 'affordability' || checkbox.id === 'convenience' || 
          checkbox.id === 'activities') {
        checkbox.addEventListener('change', function() {
          const checkedPriorities = document.querySelectorAll('#safety:checked, #education:checked, #affordability:checked, #convenience:checked, #activities:checked');
          if (checkedPriorities.length > 3) {
            this.checked = false;
            alert('Please select a maximum of 3 priorities');
          }
        });
      }
    });

    // Convert address to coordinates using Geocoding API
    async function getCoordinates(address) {
      try {
        // For demo purposes, we'll use hardcoded coordinates for major Texas cities
        // In a real app, you would use a geocoding service like Google Maps API
        const cities = {
          'austin': { lat: 30.2672, lng: -97.7431 },
          'dallas': { lat: 32.7767, lng: -96.7970 },
          'houston': { lat: 29.7604, lng: -95.3698 },
          'san antonio': { lat: 29.4252, lng: -98.4946 },
          'fort worth': { lat: 32.7555, lng: -97.3308 },
          'el paso': { lat: 31.7619, lng: -106.4850 },
          'arlington': { lat: 32.7357, lng: -97.1081 }
        };

        // Check if the address matches any of our predefined cities
        const lowerAddress = address.toLowerCase();
        for (const [city, coords] of Object.entries(cities)) {
          if (lowerAddress.includes(city)) {
            return coords;
          }
        }

        // Default to Austin if no match
        return cities.austin;
      } catch (error) {
        console.error('Error getting coordinates:', error);
        return null;
      }
    }

    // Format rating stars
    function formatStars(rating) {
      if (!rating) return 'Not rated';
      
      // Convert to a 5-star scale if it's using a different scale
      const normalizedRating = rating <= 5 ? rating : rating / 2;
      
      const fullStars = Math.floor(normalizedRating);
      const halfStar = normalizedRating % 1 >= 0.5;
      
      let starsHTML = '';
      for (let i = 0; i < fullStars; i++) {
        starsHTML += '★';
      }
      
      if (halfStar) {
        starsHTML += '½';
      }
      
      // Add empty stars to make it always 5 stars
      const emptyStars = 5 - fullStars - (halfStar ? 1 : 0);
      for (let i = 0; i < emptyStars; i++) {
        starsHTML += '☆';
      }
      
      return `<span class="stars">${starsHTML}</span> (${rating})`;
    }

    // Format price
    function formatPrice(price) {
      if (!price) return 'Price not available';
      return `<span class="price">$${price}/month</span>`;
    }

    // Perform the daycare search
    async function searchDaycares() {
      // Show loader and hide previous results
      document.getElementById('loader').style.display = 'block';
      document.getElementById('results-container').classList.add('hidden');
      document.getElementById('error-message').classList.add('hidden');
      
      try {
        // Get user inputs
        const address = document.getElementById('location').value;
        if (!address) {
          throw new Error('Please enter your location');
        }
        
        // Get coordinates from address
        const coordinates = await getCoordinates(address);
        if (!coordinates) {
          throw new Error('Could not determine your location. Please try a different address.');
        }
        
        // Get other form values
        const radius = document.getElementById('radius').value;
        const ageGroup = document.getElementById('ageGroup').value;
        const priceRange = document.getElementById('priceRange').value;
        
        // Get special programs
        const specialPrograms = [];
        if (document.getElementById('transportation').checked) specialPrograms.push('transportation');
        if (document.getElementById('meals').checked) specialPrograms.push('meals');
        if (document.getElementById('specialNeeds').checked) specialPrograms.push('special_needs');
        if (document.getElementById('extendedHours').checked) specialPrograms.push('night_care');
        if (document.getElementById('afterSchool').checked) specialPrograms.push('after_school');
        if (document.getElementById('accredited').checked) specialPrograms.push('accredited');
        
        // Get priorities
        const priorities = [];
        if (document.getElementById('safety').checked) priorities.push('safety');
        if (document.getElementById('education').checked) priorities.push('educational');
        if (document.getElementById('affordability').checked) priorities.push('affordability');
        if (document.getElementById('convenience').checked) priorities.push('convenience');
        if (document.getElementById('activities').checked) priorities.push('activities');
        
        // Build API URL
        let apiUrl = `/api/daycare-finder/recommendations?lat=${coordinates.lat}&lng=${coordinates.lng}&radius=${radius}`;
        
        if (ageGroup) apiUrl += `&ageGroup=${ageGroup}`;
        if (priceRange) apiUrl += `&priceRange=${priceRange}`;
        if (specialPrograms.length > 0) apiUrl += `&specialPrograms=${specialPrograms.join(',')}`;
        if (priorities.length > 0) apiUrl += `&priorities=${priorities.join(',')}`;
        
        // Make API call
        const response = await fetch(apiUrl);
        if (!response.ok) {
          throw new Error(`Error fetching recommendations: ${response.statusText}`);
        }
        
        const data = await response.json();
        
        // Hide loader
        document.getElementById('loader').style.display = 'none';
        
        // Display results
        displayResults(data, address);
      } catch (error) {
        // Hide loader and show error
        document.getElementById('loader').style.display = 'none';
        document.getElementById('error-message').textContent = error.message;
        document.getElementById('error-message').classList.remove('hidden');
        console.error('Search error:', error);
      }
    }

    // Display search results
    function displayResults(data, searchLocation) {
      const resultsContainer = document.getElementById('results-container');
      const resultsList = document.getElementById('results-list');
      const resultsSummary = document.getElementById('results-summary');
      
      // Clear previous results
      resultsList.innerHTML = '';
      
      if (!data.success || !data.recommendations || data.recommendations.length === 0) {
        resultsSummary.textContent = 'No daycares found matching your criteria. Try expanding your search radius or adjusting your filters.';
        resultsContainer.classList.remove('hidden');
        return;
      }
      
      // Update summary
      resultsSummary.textContent = `Found ${data.recommendations.length} daycares near ${searchLocation}. Showing top recommendations based on your preferences.`;
      
      // Create daycare cards
      data.recommendations.forEach(daycare => {
        const card = document.createElement('div');
        card.className = 'daycare-card';
        
        // Format programs and highlights based on daycare attributes
        const programs = [];
        const highlights = [];
        
        if (daycare.serves_infant === 1) programs.push('Infant Care');
        if (daycare.serves_toddler === 1) programs.push('Toddler Care');
        if (daycare.serves_preschool === 1) programs.push('Preschool');
        if (daycare.serves_school_age === 1) programs.push('School Age Care');
        
        if (daycare.has_meals_provided === 1) highlights.push('Meals Provided');
        if (daycare.has_transportation_school === 1) highlights.push('Transportation');
        if (daycare.has_special_needs === 1) highlights.push('Special Needs Support');
        if (daycare.has_accredited === 1) highlights.push('Accredited');
        if (daycare.has_night_care === 1) highlights.push('Extended Hours');
        
        // Calculate match score percentage for display
        const matchPercentage = Math.round(daycare.score * 100);
        
        // Display warnings for high risk violations
        const highRiskWarning = daycare.high_risk_violation_count > 0 
          ? `<span class="warning-pill">${daycare.high_risk_violation_count} High Risk Violation${daycare.high_risk_violation_count > 1 ? 's' : ''}</span>` 
          : '';
        
        card.innerHTML = `
          <div class="daycare-name">${daycare.operation_name} <span class="score-pill">${matchPercentage}% Match</span> ${highRiskWarning}</div>
          <div class="daycare-details">
            <div class="detail-group">
              <div class="detail-label">Rating:</div>
              <div>${formatStars(daycare.overall_rating)}</div>
            </div>
            <div class="detail-group">
              <div class="detail-label">Cost:</div>
              <div>${formatPrice(daycare.monthly_cost)}</div>
            </div>
            <div class="detail-group">
              <div class="detail-label">Address:</div>
              <div>${daycare.address}, ${daycare.city}</div>
            </div>
            <div class="detail-group">
              <div class="detail-label">Distance:</div>
              <div>${daycare.distance ? daycare.distance.toFixed(1) : 'Unknown'} miles away</div>
            </div>
            <div class="detail-group">
              <div class="detail-label">Type:</div>
              <div>${daycare.operation_type || 'Not specified'}</div>
            </div>
            <div class="detail-group">
              <div class="detail-label">Capacity:</div>
              <div>${daycare.total_capacity || 'Not specified'}</div>
            </div>
            <div class="detail-group">
              <div class="detail-label">Phone:</div>
              <div>${daycare.phone_number || 'Not available'}</div>
            </div>
            <div class="detail-group">
              <div class="detail-label">Hours:</div>
              <div>${daycare.hours_of_operation || 'Not specified'}</div>
            </div>
          </div>
          ${programs.length > 0 ? `
          <div class="programs" style="margin-top: 10px;">
            ${programs.map(program => `<span class="badge badge-blue">${program}</span>`).join('')}
          </div>` : ''}
          ${highlights.length > 0 ? `
          <div class="highlights" style="margin-top: 10px;">
            ${highlights.map(highlight => `<span class="badge badge-green">${highlight}</span>`).join('')}
          </div>` : ''}
          ${daycare.violation_count > 0 ? `
          <div class="violations" style="margin-top: 10px;">
            <span class="badge badge-orange">${daycare.violation_count} Violation${daycare.violation_count > 1 ? 's' : ''} in Last 2 Years</span>
          </div>` : ''}
        `;
        
        resultsList.appendChild(card);
      });
      
      // Show results
      resultsContainer.classList.remove('hidden');
    }
  </script>
</body>
</html>